{% extends "base.html" %}

{% block title %}比較檔案 - SFTP 下載與比較系統{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/compare.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-code-compare"></i> 比較檔案差異
        </h1>
        <p class="page-subtitle">選擇來源目錄並執行比對分析</p>
    </div>

    <!-- 比對表單 -->
    <div class="compare-form" id="compareForm">
        <!-- 步驟 1：選擇來源目錄 -->
        <div class="step-section">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h2 class="step-title">選擇來源目錄</h2>
                    <p class="step-subtitle">選擇要進行比對的目錄或路徑</p>
                </div>
            </div>
            
            <div class="section-body">
                <div class="source-tabs">
                    <button class="tab-btn active" onclick="switchSourceTab('local')">
                        <i class="fas fa-folder"></i> 選擇本地目錄
                    </button>
                    <button class="tab-btn" onclick="switchSourceTab('server')">
                        <i class="fas fa-server"></i> 選擇伺服器目錄
                    </button>
                </div>

                <!-- 標籤內容 -->
                <div class="tab-container">
                    <!-- 本地目錄 -->
                    <div class="tab-content active" id="local-tab">
                        <div class="upload-container" id="localDirectoryArea">
                            <input type="file" id="localDirectoryInput" webkitdirectory style="display: none;">
                            <div class="upload-icon-wrapper">
                                <i class="fas fa-folder-open fa-4x"></i>
                            </div>
                            <div class="upload-text">拖曳資料夾到這裡</div>
                            <div class="upload-hint">或點擊選擇目錄</div>
                            <div class="hint-card">
                                <i class="fas fa-info-circle"></i>
                                <span>請選擇包含模組檔案的目錄</span>
                            </div>
                            <p></p>
                            <button class="btn btn-primary" onclick="selectLocalDirectory()">
                                <i class="fas fa-folder-open"></i> 選擇目錄
                            </button>
                        </div>
                        
                        <div class="directory-dropdown mt-4">
                            <label class="form-label">
                                <i class="fas fa-folder-tree"></i> 或選擇已下載的目錄
                            </label>
                            <select class="form-input" id="downloadedDirectories">
                                <option value="">請選擇目錄...</option>
                            </select>
                        </div>
                        
                        <div class="file-list mt-4 hidden" id="selectedDirectoryInfo">
                            <!-- 顯示已選擇的目錄資訊 -->
                        </div>
                    </div>
                    
                    <!-- 伺服器目錄 -->
                    <div class="tab-content" id="server-tab">
                        <div class="server-browser">
                            <div class="browser-header">
                                <div class="path-input-container">
                                    <input type="text" 
                                        class="path-input" 
                                        id="serverPathInput" 
                                        placeholder="輸入或貼上路徑..."
                                        value="/home/vince_lin/ai/preMP"
                                        autocomplete="off">
                                    <!-- 新增：路徑建議下拉框 -->
                                    <div class="path-suggestions" id="pathSuggestions">
                                        <!-- 動態生成路徑建議 -->
                                    </div>
                                </div>
                                <button class="btn-go" onclick="goToPath()">
                                    <i class="fas fa-arrow-right"></i> 前往
                                </button>
                                <button class="btn-refresh" onclick="refreshServerPath()">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                            
                            <!-- 路徑麵包屑列 - 只保留這一個路徑顯示 -->
                            <div class="path-breadcrumb-bar">
                                <i class="fas fa-folder-open"></i>
                                <span class="breadcrumb-path" id="currentPathDisplay">/home/vince_lin/ai/preMP</span>
                            </div>
                            
                            <!-- 資料夾瀏覽區域 -->
                            <div class="browser-content" id="serverBrowser">
                                <div class="empty-message">
                                    <i class="fas fa-folder-open fa-3x"></i>
                                    <p>載入中...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="selected-server-files hidden" id="serverSelectedDirectory">
                            <!-- 顯示已選擇的伺服器目錄 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 步驟 2：比對設定 -->
        <div class="step-section">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h2 class="step-title">比對設定</h2>
                    <p class="step-subtitle">選擇要執行的比對情境</p>
                </div>
            </div>
            
            <div class="section-body">
                <div class="scenario-selector">
                    <!-- 執行所有比對 -->
                    <div class="scenario-card">
                        <input type="radio" name="scenario" id="scenario-all" value="all" checked>
                        <label for="scenario-all">
                            <div class="scenario-icon">
                                <i class="fas fa-globe"></i>
                            </div>
                            <div class="scenario-info">
                                <h3 class="scenario-name">執行所有比對</h3>
                                <p class="scenario-desc">自動執行下列所有可能的比對情境</p>
                                <ul class="scenario-features">
                                    <li><i class="fas fa-check"></i> 包含所有版本</li>
                                    <li><i class="fas fa-check"></i> 自動偵測路徑</li>
                                    <li><i class="fas fa-check"></i> 可能的比對情境</li>
                                </ul>
                            </div>
                        </label>
                    </div>
                    
                    <!-- Master vs PreMP -->
                    <div class="scenario-card">
                        <input type="radio" name="scenario" id="scenario-master-premp" value="master_vs_premp">
                        <label for="scenario-master-premp">
                            <div class="scenario-icon">
                                <i class="fas fa-code-branch"></i>
                            </div>
                            <div class="scenario-info">
                                <h3 class="scenario-name">Master vs PreMP</h3>
                                <p class="scenario-desc">比較主版本與預量產版本</p>
                                <ul class="scenario-features">
                                    <li><i class="fas fa-check"></i> 比較主版</li>
                                    <li><i class="fas fa-check"></i> 主物預量產版本</li>
                                    <li><i class="fas fa-check"></i> 產成本</li>
                                </ul>
                            </div>
                        </label>
                    </div>
                    
                    <!-- PreMP vs Wave -->
                    <div class="scenario-card">
                        <input type="radio" name="scenario" id="scenario-premp-wave" value="premp_vs_wave">
                        <label for="scenario-premp-wave">
                            <div class="scenario-icon">
                                <i class="fas fa-water"></i>
                            </div>
                            <div class="scenario-info">
                                <h3 class="scenario-name">PreMP vs Wave</h3>
                                <p class="scenario-desc">比較預量產與 Wave 版本</p>
                                <ul class="scenario-features">
                                    <li><i class="fas fa-check"></i> 產品</li>
                                    <li><i class="fas fa-check"></i> Wave 版本</li>
                                </ul>
                            </div>
                        </label>
                    </div>
                    
                    <!-- Wave vs Backup -->
                    <div class="scenario-card">
                        <input type="radio" name="scenario" id="scenario-wave-backup" value="wave_vs_backup">
                        <label for="scenario-wave-backup">
                            <div class="scenario-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="scenario-info">
                                <h3 class="scenario-name">Wave vs Backup</h3>
                                <p class="scenario-desc">比較 Wave 版本與備份版本</p>
                                <ul class="scenario-features">
                                    <li><i class="fas fa-check"></i> 比較 Wave</li>
                                    <li><i class="fas fa-check"></i> 版本備份</li>
                                    <li><i class="fas fa-check"></i> 份版本</li>
                                </ul>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- 執行按鈕移到這裡 -->
                <div class="scenario-action">
                    <button class="btn btn-primary btn-large" id="compareBtn" onclick="executeCompare()" disabled>
                        <span>開始執行 →</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 比對進度 -->
    <div class="compare-progress hidden" id="compareProgress">
        <div class="step-section">
            <div class="step-header">
                <div class="step-number">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="step-content">
                    <h2 class="step-title">正在比對檔案</h2>
                    <p class="step-subtitle">請稍候，系統正在分析檔案差異...</p>
                </div>
            </div>
            
            <div class="section-body">
                <!-- 進度條 -->
                <div class="progress-bar-wrapper">
                    <div class="progress-header">
                        <div class="progress-title">比對進度</div>
                        <div class="progress-percentage" id="compareProgressText">0%</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="compareProgressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-message mt-3" id="compareMessage">
                        正在準備比對...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 比對結果 -->
    <div class="compare-results hidden" id="compareResults">
        <div class="step-section">
            <div class="step-header">
                <div class="step-number">
                    <i class="fas fa-check"></i>
                </div>
                <div class="step-content">
                    <h2 class="step-title">比對完成</h2>
                    <p class="step-subtitle">檔案差異分析已完成</p>
                </div>
            </div>
            
            <div class="section-body">
                <div class="result-summary" id="resultsSummary">
                    <!-- 動態生成結果摘要 -->
                </div>
                
                <div class="result-actions">
                    <button class="btn btn-primary" onclick="viewDetailedResults()">
                        <i class="fas fa-table"></i> 查看詳細報表
                    </button>
                    <button class="btn btn-success" onclick="exportResults('excel')">
                        <i class="fas fa-file-excel"></i> 匯出 Excel
                    </button>
                    <button class="btn btn-info" onclick="exportResults('html')">
                        <i class="fas fa-file-code"></i> 匯出 HTML
                    </button>
                    <button class="btn btn-warning" onclick="exportResults('zip')">
                        <i class="fas fa-file-archive"></i> 下載 ZIP
                    </button>
                </div>
                <!-- 新增：再比一次的引導按鈕 -->
                <div class="result-actions mt-4" style="border-top: 1px solid var(--border-light); padding-top: 2rem;">
                    <button class="btn btn-primary btn-large" onclick="compareNewData()">
                        <i class="fas fa-redo"></i> 再比一筆
                    </button>
                </div>                
                <!-- 圖表區域 -->
                <div class="charts-container mt-4">
                    <div class="chart-card">
                        <h3 class="chart-title">比對成功率</h3>
                        <canvas id="successChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3 class="chart-title">差異分布</h3>
                        <canvas id="diffChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 最近比對記錄 -->
    <div class="step-section mt-4">
        <div class="step-header">
            <div class="step-number">
                <i class="fas fa-history"></i>
            </div>
            <div class="step-content">
                <h2 class="step-title">最近比對記錄</h2>
                <p class="step-subtitle">查看之前的比對結果</p>
            </div>
        </div>
        <div class="section-body">
            <div class="timeline-container" id="comparisonTimeline">
                <div class="timeline-empty">
                    <i class="fas fa-inbox fa-3x"></i>
                    <p>暫無比對記錄</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 非同步下載提示 -->
<div class="async-download-toast hidden" id="asyncDownloadToast">
    <div class="toast-icon">
        <i class="fas fa-check"></i>
    </div>
    <div class="toast-content">
        <div class="toast-title">下載準備完成</div>
        <div class="toast-desc">您的檔案已準備好下載</div>
    </div>
    <button class="btn btn-primary btn-small" onclick="downloadAsyncFile()">
        立即下載
    </button>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/compare.js') }}"></script>
{% endblock %}