{% extends "base.html" %}

{% block title %}後台管理 - SFTP 下載與比較系統{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-cog"></i> 後台管理
        </h1>
        <p class="page-subtitle">Chip Mapping 與 Prebuild Mapping 管理工具</p>
    </div>

    <!-- 功能選擇標籤 -->
    <div class="function-tabs">
        <button class="tab-btn active" onclick="switchFunction('chip-mapping')">
            <i class="fas fa-microchip"></i> Chip Mapping
        </button>
        <button class="tab-btn" onclick="switchFunction('prebuild-mapping')">
            <i class="fas fa-layer-group"></i> Prebuild Mapping
        </button>
    </div>

    <!-- Chip Mapping 功能 -->
    <div class="function-content active" id="chip-mapping-content">
        <!-- Step 1: 選擇 Mapping Table -->
        <div class="step-section">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h2 class="step-title">選擇 Mapping Table</h2>
                    <p class="step-subtitle">選擇來源方式</p>
                </div>
            </div>
            
            <div class="section-body">
                <!-- 來源選擇開關 -->
                <div class="source-selector">
                    <div class="source-option">
                        <label class="switch-label">
                            <input type="radio" name="mappingSource" value="default" id="useDefaultMapping" checked onchange="toggleMappingSource()">
                            <span class="radio-text">使用預設檔案 (伺服器)</span>
                        </label>
                        <div class="source-description">
                            使用伺服器上的預設 all_chip_mapping_table.xlsx
                        </div>
                    </div>
                    
                    <div class="source-option">
                        <label class="switch-label">
                            <input type="radio" name="mappingSource" value="upload" id="useUploadMapping" onchange="toggleMappingSource()">
                            <span class="radio-text">上傳檔案</span>
                        </label>
                        <div class="source-description">
                            上傳自己的 mapping table 檔案
                        </div>
                    </div>
                </div>

                <!-- 預設檔案區域 -->
                <div class="default-file-area" id="defaultFileArea">
                    <div class="default-file-card">
                        <div class="file-icon">
                            <i class="fas fa-server"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name">all_chip_mapping_table.xlsx</div>
                            <div class="file-path">{{ config.DEFAULT_MAPPING_TABLE_PATH or '/home/vince_lin/ai/preMP/vp_lib/' }}</div>
                        </div>
                        <button class="btn btn-primary" id="loadDefaultFile" onclick="loadDefaultMappingTable()">
                            <i class="fas fa-download"></i> 載入檔案
                        </button>
                    </div>
                </div>

                <!-- 上傳檔案區域 -->
                <div class="upload-container" id="mappingUploadArea" style="display: none;">
                    <input type="file" id="mappingFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                    <div class="upload-icon-wrapper">
                        <i class="fas fa-file-excel fa-4x"></i>
                    </div>
                    <div class="upload-text">拖曳 Mapping Table 檔案到這裡</div>
                    <div class="upload-hint">或點擊選擇檔案</div>
                    <div class="hint-card">
                        <i class="fas fa-info-circle"></i>
                        <span>支援 .xlsx、.xls、.csv 格式</span>
                    </div>
                    <p></p>
                    <button class="btn btn-primary" onclick="document.getElementById('mappingFileInput').click()">
                        <i class="fas fa-folder-open"></i> 選擇檔案
                    </button>
                </div>
                
                <div class="file-list mt-4" id="mappingFileList">
                    <!-- 顯示已選擇的檔案 -->
                </div>
            </div>
        </div>

        <!-- Step 2: 設定參數 -->
        <div class="step-section">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h2 class="step-title">設定參數</h2>
                    <p class="step-subtitle">選擇 Filter 類型和 DB 版本 (支援多選)</p>
                </div>
            </div>
            
            <div class="section-body">
                <!-- Filter 類型 -->
                <div class="dynamic-param-group">
                    <label class="form-label">
                        <i class="fas fa-filter"></i> Filter 類型
                        <button class="btn-add" onclick="addFilterType()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </label>
                    <div class="dynamic-items" id="filterTypeItems">
                        <div class="dynamic-item" data-index="0">
                            <select class="form-select" name="filterType" data-index="0">
                                <option value="all">All</option>
                                <option value="master_vs_premp">Master vs PreMP</option>
                                <option value="premp_vs_mp">PreMP vs MP</option>
                                <option value="mp_vs_mpbackup">MP vs MP Backup</option>
                            </select>
                            <button class="btn-remove" onclick="removeFilterType(0)" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-hint mt-2">
                        <i class="fas fa-info-circle"></i>
                        <span>多個條件將使用 OR 邏輯連接</span>
                    </div>
                </div>

                <!-- Chip Filter -->
                <div class="dynamic-param-group">
                    <label class="form-label">
                        <i class="fas fa-microchip"></i> Chip Filter
                        <button class="btn-add" onclick="addChipFilter()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </label>
                    <div class="dynamic-items" id="chipFilterItems">
                        <div class="dynamic-item" data-index="0">
                            <select class="form-select" name="chipFilter" data-index="0">
                                <option value="all">All Chips</option>
                            </select>
                            <button class="btn-remove" onclick="removeChipFilter(0)" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-hint mt-2">
                        <i class="fas fa-info-circle"></i>
                        <span>選擇特定的晶片類型</span>
                    </div>
                </div>
                <!-- DB 選擇與版本設定 -->
                <div class="dynamic-param-group">
                    <label class="form-label">
                        <i class="fas fa-database"></i> DB 選擇與版本設定
                        <button class="btn-add" onclick="addDBFilter()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </label>
                    <div class="dynamic-items" id="dbFilterItems">
                        <div class="dynamic-item" data-index="0">
                            <select class="form-select" name="dbFilter" data-index="0" onchange="handleDBSelection(this)">
                                <option value="all">All</option>
                                <option value="" disabled>請先載入 Mapping Table</option>
                            </select>
                            <button class="btn-remove" onclick="removeDBFilter(0)" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- DB 版本選擇 -->
                    <div id="dbVersionGroup" style="display: none; margin-top: 20px;">
                        <div class="db-version-header">
                            <i class="fas fa-code-branch"></i>
                            <span>版本選擇（可選）</span>
                        </div>
                        <div id="dbVersionSelectors">
                            <!-- 動態生成版本選擇器 -->
                        </div>
                    </div>
                    
                    <div class="form-hint mt-2">
                        <i class="fas fa-info-circle"></i>
                        <span>可選擇多個 DB 進行處理，並指定特定版本</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: 輸出設定 -->
        <div class="step-section">
            <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h2 class="step-title">輸出設定</h2>
                    <p class="step-subtitle">選擇結果儲存位置</p>
                </div>
            </div>
            
            <div class="section-body">
                <div class="output-config">
                    <div class="output-path-group">
                        <label class="output-label">
                            <i class="fas fa-folder"></i> 輸出路徑
                        </label>
                        <div class="output-input-wrapper">
                            <input type="text" 
                                class="output-input" 
                                id="chipOutputPath" 
                                placeholder="輸入路徑或選擇目錄..."
                                value="./output/chip_mapping">
                            <button class="output-browse-btn" onclick="browseOutputPath('chip')">
                                <i class="fas fa-folder-open"></i> 瀏覽
                            </button>
                        </div>
                    </div>
                    
                    <div class="quick-directory-section">
                        <div class="quick-directory-header">
                            <label class="form-label">
                                <i class="fas fa-history"></i> 使用已下載的目錄
                            </label>
                            <label class="directory-toggle">
                                <input type="checkbox" id="chipUseQuickPath" onchange="toggleQuickPath('chip')">
                                <span class="toggle-indicator"></span>
                            </label>
                        </div>
                        <div class="quick-directory-content" id="chipQuickPathGroup" style="display: none;">
                            <select class="directory-select" id="chipQuickPath" onchange="updateQuickPath('chip')">
                                <option value="">-- 選擇目錄 --</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 執行按鈕 -->
        <div class="action-container">
            <button class="btn btn-primary btn-large" onclick="runChipMapping()">
                <i class="fas fa-play"></i> 執行 Chip Mapping
            </button>
        </div>
    </div>

    <!-- Prebuild Mapping 功能 -->
    <div class="function-content" id="prebuild-mapping-content">
        <!-- Step 1: 選擇比對檔案 -->
        <div class="step-section">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h2 class="step-title">選擇比對檔案</h2>
                    <p class="step-subtitle">上傳需要比對的 Excel 檔案</p>
                </div>
            </div>
            
            <div class="section-body">
                <div class="file-upload-grid">
                    <!-- Master 檔案 -->
                    <div class="file-upload-card">
                        <div class="upload-card-header">
                            <h3>Master</h3>
                            <span class="upload-status" id="masterStatus">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </span>
                        </div>
                        <div class="upload-area" id="masterUploadArea">
                            <input type="file" id="masterFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                            <i class="fas fa-file-excel fa-3x"></i>
                            <p>拖曳檔案或點擊上傳</p>
                            <button class="btn btn-small btn-primary" onclick="document.getElementById('masterFileInput').click()">
                                選擇檔案
                            </button>
                        </div>
                        <div class="selected-file" id="masterSelected" style="display: none;"></div>
                    </div>

                    <!-- PreMP 檔案 -->
                    <div class="file-upload-card">
                        <div class="upload-card-header">
                            <h3>PreMP</h3>
                            <span class="upload-status" id="prempStatus">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </span>
                        </div>
                        <div class="upload-area" id="prempUploadArea">
                            <input type="file" id="prempFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                            <i class="fas fa-file-excel fa-3x"></i>
                            <p>拖曳檔案或點擊上傳</p>
                            <button class="btn btn-small btn-primary" onclick="document.getElementById('prempFileInput').click()">
                                選擇檔案
                            </button>
                        </div>
                        <div class="selected-file" id="prempSelected" style="display: none;"></div>
                    </div>

                    <!-- MP 檔案 -->
                    <div class="file-upload-card">
                        <div class="upload-card-header">
                            <h3>MP</h3>
                            <span class="upload-status" id="mpStatus">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </span>
                        </div>
                        <div class="upload-area" id="mpUploadArea">
                            <input type="file" id="mpFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                            <i class="fas fa-file-excel fa-3x"></i>
                            <p>拖曳檔案或點擊上傳</p>
                            <button class="btn btn-small btn-primary" onclick="document.getElementById('mpFileInput').click()">
                                選擇檔案
                            </button>
                        </div>
                        <div class="selected-file" id="mpSelected" style="display: none;"></div>
                    </div>

                    <!-- MP Backup 檔案 -->
                    <div class="file-upload-card">
                        <div class="upload-card-header">
                            <h3>MP Backup</h3>
                            <span class="upload-status" id="mpbackupStatus">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </span>
                        </div>
                        <div class="upload-area" id="mpbackupUploadArea">
                            <input type="file" id="mpbackupFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                            <i class="fas fa-file-excel fa-3x"></i>
                            <p>拖曳檔案或點擊上傳</p>
                            <button class="btn btn-small btn-primary" onclick="document.getElementById('mpbackupFileInput').click()">
                                選擇檔案
                            </button>
                        </div>
                        <div class="selected-file" id="mpbackupSelected" style="display: none;"></div>
                    </div>
                </div>

                <!-- 比對類型提示 -->
                <div class="filter-hint">
                    <i class="fas fa-info-circle"></i>
                    <span>系統將根據您選擇的檔案自動決定比對類型</span>
                    <div class="filter-preview" id="filterPreview"></div>
                </div>
            </div>
        </div>

        <!-- Step 2: 輸出設定 -->
        <div class="step-section">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h2 class="step-title">輸出設定</h2>
                    <p class="step-subtitle">選擇結果儲存位置</p>
                </div>
            </div>
            
            <div class="section-body">
                <div class="output-selector">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-folder"></i> 輸出路徑
                        </label>
                        <div class="path-input-group">
                            <input type="text" 
                                class="form-input" 
                                id="prebuildOutputPath" 
                                placeholder="輸入路徑或選擇目錄..."
                                value="{{ config.DEFAULT_PREBUILD_OUTPUT_DIR if config.DEFAULT_PREBUILD_OUTPUT_DIR else './output/prebuild_mapping' }}">
                            <button class="btn btn-secondary" onclick="browseOutputPath('prebuild')">
                                <i class="fas fa-folder-open"></i> 瀏覽
                            </button>
                        </div>
                    </div>
                    
                    <div class="quick-select">
                        <div class="quick-select-header">
                            <label class="form-label">
                                <i class="fas fa-history"></i> 使用已下載的目錄
                            </label>
                            <!-- 切換開關 -->
                            <label class="toggle-switch">
                                <input type="checkbox" id="prebuildUseQuickPath" onchange="toggleQuickPath('prebuild')">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="quick-path-select" id="prebuildQuickPathGroup" style="display: none;">
                            <select class="form-select" id="prebuildQuickPath" onchange="updateQuickPath('prebuild')">
                                <option value="">-- 選擇目錄 --</option>
                            </select>
                        </div>
                    </div>

                    <!-- 執行說明 -->
                    <div class="execution-hint">
                        <i class="fas fa-info-circle"></i>
                        <div class="hint-content">
                            <strong>執行說明：</strong>
                            <ul>
                                <li>master + premp → PrebuildFW_master_vs_premp_mapping.xlsx</li>
                                <li>premp + mp → PrebuildFW_premp_vs_mp_mapping.xlsx</li>
                                <li>mp + mpbackup → PrebuildFW_mp_vs_mpbackup_mapping.xlsx</li>
                            </ul>
                            <p>系統會根據上傳的檔案組合自動執行相應的比對</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 執行按鈕 -->
        <div class="action-container">
            <button class="btn btn-primary btn-large" onclick="runPrebuildMapping()">
                <i class="fas fa-play"></i> 執行 Prebuild Mapping
            </button>
        </div>
    </div>

    <!-- 結果顯示區域 -->
    <div class="result-section hidden" id="resultSection">
        <div class="step-section">
            <div class="step-header">
                <div class="step-number">
                    <i class="fas fa-check"></i>
                </div>
                <div class="step-content">
                    <h2 class="step-title">執行結果</h2>
                    <p class="step-subtitle">查看和匯出結果資料</p>
                </div>
            </div>
            
            <div class="section-body">
                <!-- 結果統計 -->
                <div class="result-stats" id="resultStats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalRows">0</div>
                            <div class="stat-label">總筆數</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-filter"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="filteredRows">0</div>
                            <div class="stat-label">篩選結果</div>
                        </div>
                    </div>
                </div>

                <!-- 工具列 -->
                <div class="result-toolbar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" 
                               class="search-input" 
                               id="searchInput" 
                               placeholder="搜尋資料...">
                    </div>
                    
                    <div class="toolbar-actions">
                        <button class="btn btn-secondary" onclick="exportResult()">
                            <i class="fas fa-file-excel"></i> 匯出 Excel
                        </button>
                        <button class="btn btn-secondary" onclick="clearResult()">
                            <i class="fas fa-times"></i> 清除結果
                        </button>
                    </div>
                </div>

                <!-- 結果表格 -->
                <div class="table-wrapper">
                    <table class="data-table" id="resultTable">
                        <thead id="resultTableHead">
                            <!-- 動態生成表頭 -->
                        </thead>
                        <tbody id="resultTableBody">
                            <!-- 動態生成資料 -->
                        </tbody>
                    </table>
                </div>

                <!-- 分頁 -->
                <div class="pagination" id="pagination">
                    <!-- 動態生成分頁 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 載入中遮罩 -->
<div class="loading-overlay hidden" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <p id="loadingText">處理中...</p>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}