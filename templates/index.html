{% extends "base.html" %}

{% block title %}首頁 - SFTP 下載與比較系統{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
<style>
/* 時間線控制面板 */
.timeline-controls {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
    align-items: center;
}

.control-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.control-group label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500;
    white-space: nowrap;
}

.control-select, .control-input {
    padding: 6px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 0.875rem;
    min-width: 100px;
}

.control-select:focus, .control-input:focus {
    outline: none;
    border-color: var(--nordic-blue);
    box-shadow: 0 0 0 2px var(--border-focus);
}

.control-btn {
    padding: 6px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.control-btn:hover {
    background: var(--bg-hover);
    border-color: var(--nordic-blue-light);
}

.control-btn.active {
    background: var(--nordic-blue);
    color: white;
    border-color: var(--nordic-blue);
}

/* 時間線統計 */
.timeline-stats {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
}

.stat-badge {
    background: var(--bg-tertiary);
    padding: 8px 16px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.stat-badge .stat-number {
    font-weight: 600;
    color: var(--nordic-blue);
    font-size: 1rem;
}

/* 時間線卡片樣式 - 仿照圖片設計 */
.timeline-card {
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    border: 1px solid var(--border-light);
}

.timeline-card-header {
    background: linear-gradient(135deg, #2196F3 0%, #64B5F6 100%);
    padding: 20px 24px;
    color: white;
    display: flex;
    align-items: center;
    gap: 12px;
}

.timeline-card-header .header-icon {
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.timeline-card-header .header-content h2 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
}

.timeline-card-header .header-content p {
    margin: 0;
    font-size: 0.875rem;
    opacity: 0.9;
}

.timeline-card-body {
    padding: 24px;
    background: #F8FBFF;
}

/* 改進的時間線樣式 */
.timeline-item {
    position: relative;
    padding-left: 80px;
    margin-bottom: 32px;
    opacity: 0;
    transform: translateX(-20px);
    animation: fadeInLeft 0.5s ease forwards;
}

.timeline-item:nth-child(n) {
    animation-delay: calc(var(--item-index, 0) * 0.1s);
}

@keyframes fadeInLeft {
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.timeline-content {
    background: white;
    padding: 20px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-light);
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.timeline-content:hover {
    transform: translateX(4px);
    box-shadow: var(--shadow-md);
    border-color: var(--nordic-blue-light);
}

.timeline-content.expanded {
    transform: translateX(4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--nordic-blue);
}

.timeline-time {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.timeline-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.timeline-desc {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 12px;
}

/* 時間線操作按鈕 */
.timeline-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border-light);
}

.timeline-action-btn {
    padding: 6px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    background: var(--bg-primary);
    color: var(--text-secondary);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 4px;
}

.timeline-action-btn:hover {
    background: var(--nordic-blue);
    color: white;
    border-color: var(--nordic-blue);
    text-decoration: none;
}

.timeline-action-btn.primary {
    background: var(--nordic-blue);
    color: white;
    border-color: var(--nordic-blue);
}

.timeline-action-btn.primary:hover {
    background: var(--nordic-blue-dark);
    border-color: var(--nordic-blue-dark);
}

/* 時間線項目詳情 */
.timeline-details {
    display: none;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border-light);
    background: var(--nordic-ice);
    border-radius: var(--radius-sm);
    padding: 12px;
}

.timeline-details.show {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
    }
    to {
        opacity: 1;
        max-height: 200px;
        padding-top: 12px;
        padding-bottom: 12px;
    }
}

.timeline-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin-top: 12px;
}

.meta-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.meta-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.meta-value {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500;
}

/* 類型標籤 */
.type-tag {
    display: inline-block;
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.type-tag.download {
    background: var(--info-light);
    color: var(--info);
}

.type-tag.compare {
    background: var(--warning-light);
    color: var(--warning);
}

.type-tag.one-step {
    background: var(--success-light);
    color: var(--success);
}

.type-tag.general {
    background: var(--bg-hover);
    color: var(--text-muted);
}

/* 載入更多按鈕 */
.load-more-btn {
    display: block;
    width: 100%;
    max-width: 200px;
    margin: 24px auto 0;
    padding: 12px 24px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.load-more-btn:hover {
    background: var(--bg-hover);
    border-color: var(--nordic-blue-light);
}

.load-more-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* 空狀態 */
.timeline-empty {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
    background: white;
    border-radius: var(--radius-md);
}

.timeline-empty i {
    margin-bottom: 16px;
    opacity: 0.5;
}

.timeline-empty p {
    font-size: 1rem;
    margin-bottom: 16px;
}

.timeline-empty .empty-action {
    color: var(--nordic-blue);
    text-decoration: none;
    font-weight: 500;
}

.timeline-empty .empty-action:hover {
    text-decoration: underline;
}

/* 動畫 */
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* 響應式設計 */
@media (max-width: 768px) {
    .timeline-card-header {
        padding: 16px 20px;
    }
    
    .timeline-card-header .header-icon {
        width: 32px;
        height: 32px;
        font-size: 1rem;
    }
    
    .timeline-card-header .header-content h2 {
        font-size: 1.125rem;
    }
    
    .timeline-card-body {
        padding: 20px;
    }
    
    .timeline-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .control-group {
        flex-wrap: wrap;
    }
    
    .timeline-stats {
        justify-content: center;
    }
    
    .timeline-item {
        padding-left: 60px;
    }
    
    .timeline-dot {
        left: 15px;
        width: 16px;
        height: 16px;
    }
    
    .timeline-container::before {
        left: 22px;
    }
    
    .timeline-meta {
        grid-template-columns: 1fr;
    }
    
    .timeline-actions {
        flex-wrap: wrap;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- 歡迎區塊 -->
    <section class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">SFTP 下載與比較系統</h1>
            <p class="hero-subtitle">智能化的檔案下載、比對與分析平台</p>
            <div class="hero-features">
                <div class="feature-tag">
                    <i class="fas fa-bolt"></i> 快速處理
                </div>
                <div class="feature-tag">
                    <i class="fas fa-chart-line"></i> 智能分析
                </div>
                <div class="feature-tag">
                    <i class="fas fa-shield-alt"></i> 安全可靠
                </div>
            </div>
        </div>
    </section>

    <!-- 功能卡片 -->
    <section class="features-grid">
        <div class="feature-card" onclick="window.location.href='{{ url_for('download_page') }}'">
            <div class="feature-icon">
                <i class="fas fa-download"></i>
            </div>
            <h3 class="feature-title">下載檔案</h3>
            <p class="feature-description">
                從 SFTP 下載檔案，支援批次處理與自動分類
            </p>
            <ul class="feature-list">
                <li><i class="fas fa-check"></i> 智能檔案搜尋</li>
                <li><i class="fas fa-check"></i> 斷點續傳</li>
                <li><i class="fas fa-check"></i> 自動分類整理</li>
            </ul>
            <button class="feature-btn">
                開始下載 <i class="fas fa-arrow-right"></i>
            </button>
        </div>

        <div class="feature-card" onclick="window.location.href='{{ url_for('compare_page') }}'">
            <div class="feature-icon">
                <i class="fas fa-code-compare"></i>
            </div>
            <h3 class="feature-title">比較差異</h3>
            <p class="feature-description">
                比較不同版本的 manifest.xml 與版本檔案差異
            </p>
            <ul class="feature-list">
                <li><i class="fas fa-check"></i> 多情境比對</li>
                <li><i class="fas fa-check"></i> 視覺化差異</li>
                <li><i class="fas fa-check"></i> 詳細報表</li>
            </ul>
            <button class="feature-btn">
                開始比較 <i class="fas fa-arrow-right"></i>
            </button>
        </div>

        <div class="feature-card highlight" onclick="window.location.href='{{ url_for('one_step_page') }}'">
            <div class="feature-icon">
                <i class="fas fa-rocket"></i>
            </div>
            <h3 class="feature-title">一步到位</h3>
            <p class="feature-description">
                自動執行下載、比對、打包全流程
            </p>
            <ul class="feature-list">
                <li><i class="fas fa-check"></i> 全自動處理</li>
                <li><i class="fas fa-check"></i> 即時進度追蹤</li>
                <li><i class="fas fa-check"></i> 一鍵完成</li>
            </ul>
            <button class="feature-btn primary">
                立即執行 <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </section>

    <!-- 比對情境說明 -->
    <section class="scenarios-section">
        <h2 class="section-title text-center mb-4">支援的比對情境</h2>
        <div class="scenario-cards">
            <div class="scenario-card">
                <div class="scenario-icon">
                    <i class="fas fa-code-branch"></i>
                </div>
                <h3 class="scenario-title">Master vs PreMP</h3>
                <p class="scenario-desc">比較主版本與預量產版本的差異</p>
                <div class="scenario-features">
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>Revision 差異檢查</span>
                    </div>
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>分支命名驗證</span>
                    </div>
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>版本檔案比對</span>
                    </div>
                </div>
            </div>
            
            <div class="scenario-card">
                <div class="scenario-icon">
                    <i class="fas fa-water"></i>
                </div>
                <h3 class="scenario-title">PreMP vs Wave</h3>
                <p class="scenario-desc">比較預量產與 Wave 版本的差異</p>
                <div class="scenario-features">
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>Revision 差異檢查</span>
                    </div>
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>分支命名驗證</span>
                    </div>
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>版本檔案比對</span>
                    </div>
                </div>
            </div>
            
            <div class="scenario-card">
                <div class="scenario-icon">
                    <i class="fas fa-database"></i>
                </div>
                <h3 class="scenario-title">Wave vs Backup</h3>
                <p class="scenario-desc">比較 Wave 版本與備份版本的差異</p>
                <div class="scenario-features">
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>Revision 差異檢查</span>
                    </div>
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>分支命名驗證</span>
                    </div>
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>版本檔案比對</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 統計資訊 -->
    <section class="stats-section">
        <div class="stats-container">
            <div class="stat-item">
                <div class="stat-number" id="totalProcessed">0</div>
                <div class="stat-label">總處理數</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="todayProcessed">0</div>
                <div class="stat-label">今日處理</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="successRate">0%</div>
                <div class="stat-label">成功率</div>
            </div>
        </div>
    </section>

    <!-- 最近活動 -->
    <section class="recent-section">
        <div class="timeline-card">
            <!-- 卡片標題欄 -->
            <div class="timeline-card-header">
                <div class="header-icon">
                    <i class="fas fa-history"></i>
                </div>
                <div class="header-content">
                    <h2>最近比對記錄</h2>
                    <p>查看所有比對結果</p>
                </div>
            </div>
            
            <!-- 卡片內容 -->
            <div class="timeline-card-body">
                <!-- 時間線控制面板 -->
                <div class="timeline-controls">
                    <div class="control-group">
                        <label for="typeFilter">類型:</label>
                        <select id="typeFilter" class="control-select">
                            <option value="all">全部</option>
                            <option value="download">下載</option>
                            <option value="compare">比較</option>
                            <option value="one-step">一步到位</option>
                            <option value="general">一般</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="timeFilter">時間:</label>
                        <select id="timeFilter" class="control-select">
                            <option value="all">全部</option>
                            <option value="today">今天</option>
                            <option value="week">本週</option>
                            <option value="month">本月</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="statusFilter">狀態:</label>
                        <select id="statusFilter" class="control-select">
                            <option value="all">全部</option>
                            <option value="success">成功</option>
                            <option value="error">失敗</option>
                            <option value="warning">警告</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <button id="sortBtn" class="control-btn active" data-order="desc">
                            <i class="fas fa-sort-amount-down"></i> 最新優先
                        </button>
                    </div>
                    
                    <div class="control-group">
                        <button id="refreshBtn" class="control-btn">
                            <i class="fas fa-sync-alt"></i> 重新整理
                        </button>
                    </div>
                </div>
                
                <!-- 時間線統計 -->
                <div class="timeline-stats">
                    <div class="stat-badge">
                        <span class="stat-number" id="totalItems">0</span> 總數
                    </div>
                    <div class="stat-badge">
                        <span class="stat-number" id="filteredItems">0</span> 顯示
                    </div>
                    <div class="stat-badge">
                        <span class="stat-number" id="successItems">0</span> 成功
                    </div>
                </div>
                
                <!-- 時間線容器 -->
                <div class="timeline-container" id="timelineContainer">
                    <div class="timeline-empty">
                        <i class="fas fa-history fa-3x"></i>
                        <p>載入中...</p>
                    </div>
                </div>
                
                <!-- 載入更多按鈕 -->
                <button id="loadMoreBtn" class="load-more-btn" style="display: none;">
                    <i class="fas fa-plus-circle"></i> 載入更多
                </button>
            </div>
        </div>
    </section>
</div>

<script>
// 全域變數
let allActivities = [];
let filteredActivities = [];
let displayedCount = 10; // 初始顯示數量
let maxDisplayCount = 10; // 每次載入更多的數量

// 頁面載入時執行
document.addEventListener('DOMContentLoaded', () => {
    loadStatistics();
    loadRecentActivities();
    initTimelineControls();
});

// 初始化時間線控制項
function initTimelineControls() {
    // 類型篩選
    document.getElementById('typeFilter').addEventListener('change', (e) => {
        filterActivities();
    });
    
    // 時間篩選
    document.getElementById('timeFilter').addEventListener('change', (e) => {
        filterActivities();
    });
    
    // 狀態篩選
    document.getElementById('statusFilter').addEventListener('change', (e) => {
        filterActivities();
    });
    
    // 排序切換
    document.getElementById('sortBtn').addEventListener('click', (e) => {
        const btn = e.currentTarget;
        const currentOrder = btn.dataset.order;
        const newOrder = currentOrder === 'desc' ? 'asc' : 'desc';
        
        btn.dataset.order = newOrder;
        btn.innerHTML = newOrder === 'desc' ? 
            '<i class="fas fa-sort-amount-down"></i> 最新優先' : 
            '<i class="fas fa-sort-amount-up"></i> 最舊優先';
        
        filterActivities();
    });
    
    // 重新整理
    document.getElementById('refreshBtn').addEventListener('click', (e) => {
        const btn = e.currentTarget;
        const icon = btn.querySelector('i');
        
        icon.style.animation = 'spin 1s linear infinite';
        loadRecentActivities().finally(() => {
            icon.style.animation = '';
        });
    });
    
    // 載入更多
    document.getElementById('loadMoreBtn').addEventListener('click', () => {
        displayedCount += maxDisplayCount;
        renderTimeline();
    });
}

// 載入統計資料
async function loadStatistics() {
    try {
        const stats = await utils.apiRequest('/api/statistics');
        animateNumber('totalProcessed', stats.total || 0);
        animateNumber('todayProcessed', stats.today || 0);
        animateNumber('successRate', stats.successRate || 0, '%');
    } catch (error) {
        console.error('Load statistics error:', error);
        // 失敗時不顯示數字，保持為 0
        animateNumber('totalProcessed', 0);
        animateNumber('todayProcessed', 0);
        animateNumber('successRate', 0, '%');
    }
}

// 數字動畫效果
function animateNumber(elementId, target, suffix = '') {
    const element = document.getElementById(elementId);
    if (!element || target === 0) {
        if (element) element.textContent = '0' + suffix;
        return;
    }
    
    const duration = 1000;
    const start = 0;
    const increment = target / (duration / 16);
    let current = start;

    const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
            current = target;
            clearInterval(timer);
        }
        element.textContent = Math.floor(current) + suffix;
    }, 16);
}

// 載入最近活動
async function loadRecentActivities() {
    try {
        const activities = await utils.apiRequest('/api/recent-activities');
        
        if (activities && activities.length > 0) {
            allActivities = activities.map(activity => {
                console.log('處理活動:', activity);
                
                // 先從 task_id 欄位取值，如果沒有就從 details 中提取
                let taskId = activity.task_id;
                console.log('原始 task_id:', taskId);
                
                if (!taskId && activity.details) {
                    taskId = extractTaskIdFromDetails(activity.details);
                    console.log('從 details 提取的 task_id:', taskId);
                }
                
                const processedActivity = {
                    id: activity.id || utils.generateId(),
                    timestamp: new Date(activity.timestamp),
                    action: activity.action,
                    status: activity.status || 'success',
                    details: activity.details,
                    type: determineActivityType(activity),
                    moduleCount: activity.moduleCount || null,
                    fileSize: activity.fileSize || null,
                    duration: activity.duration || null,
                    task_id: taskId,
                    resultUrl: activity.resultUrl || null
                };
                
                console.log('最終處理的活動:', processedActivity);
                return processedActivity;
            });
        } else {
            allActivities = [];
        }
    } catch (error) {
        console.error('Load recent activities error:', error);
        allActivities = [];
    }
    
    filterActivities();
}

// 根據活動內容判斷類型
function determineActivityType(activity) {
    if (activity.type) return activity.type;
    
    const action = activity.action.toLowerCase();
    if (action.includes('下載') || action.includes('download')) return 'download';
    if (action.includes('比對') || action.includes('比較') || action.includes('vs') || action.includes('compare')) return 'compare';
    if (action.includes('一步到位') || action.includes('one-step')) return 'one-step';
    return 'general';
}

// 篩選活動
function filterActivities() {
    const typeFilter = document.getElementById('typeFilter').value;
    const timeFilter = document.getElementById('timeFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const sortOrder = document.getElementById('sortBtn').dataset.order;
    
    // 篩選
    filteredActivities = allActivities.filter(activity => {
        // 類型篩選
        if (typeFilter !== 'all' && activity.type !== typeFilter) {
            return false;
        }
        
        // 狀態篩選
        if (statusFilter !== 'all' && activity.status !== statusFilter) {
            return false;
        }
        
        // 時間篩選
        if (timeFilter !== 'all') {
            const now = new Date();
            const activityDate = new Date(activity.timestamp);
            
            switch (timeFilter) {
                case 'today':
                    if (activityDate.toDateString() !== now.toDateString()) {
                        return false;
                    }
                    break;
                case 'week':
                    const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                    if (activityDate < weekAgo) {
                        return false;
                    }
                    break;
                case 'month':
                    const monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
                    if (activityDate < monthAgo) {
                        return false;
                    }
                    break;
            }
        }
        
        return true;
    });
    
    // 排序
    filteredActivities.sort((a, b) => {
        const timeA = new Date(a.timestamp).getTime();
        const timeB = new Date(b.timestamp).getTime();
        return sortOrder === 'desc' ? timeB - timeA : timeA - timeB;
    });
    
    // 重置顯示數量
    displayedCount = maxDisplayCount;
    
    // 更新統計
    updateTimelineStats();
    
    // 渲染時間線
    renderTimeline();
}

// 更新時間線統計
function updateTimelineStats() {
    document.getElementById('totalItems').textContent = allActivities.length;
    document.getElementById('filteredItems').textContent = filteredActivities.length;
    
    const successCount = filteredActivities.filter(a => a.status === 'success').length;
    document.getElementById('successItems').textContent = successCount;
}

// 渲染時間線
function renderTimeline() {
    const container = document.getElementById('timelineContainer');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    
    if (filteredActivities.length === 0) {
        container.innerHTML = `
            <div class="timeline-empty">
                <i class="fas fa-search fa-3x"></i>
                <p>沒有找到符合條件的活動</p>
                <a href="#" class="empty-action" onclick="clearAllFilters()">清除篩選條件</a>
            </div>
        `;
        loadMoreBtn.style.display = 'none';
        return;
    }
    
    const displayActivities = filteredActivities.slice(0, displayedCount);
    let html = '';
    
    displayActivities.forEach((activity, index) => {
        html += createTimelineItem(activity, index);
    });
    
    container.innerHTML = html;
    
    // 載入更多按鈕
    if (displayedCount < filteredActivities.length) {
        loadMoreBtn.style.display = 'block';
        loadMoreBtn.textContent = `載入更多 (還有 ${filteredActivities.length - displayedCount} 項)`;
    } else {
        loadMoreBtn.style.display = 'none';
    }
    
    // 添加點擊事件
    addTimelineEvents();
}

// 創建時間線項目
function createTimelineItem(activity, index) {
    const statusIcon = getStatusIcon(activity.status);
    const typeTag = getTypeTag(activity.type);
    const timeAgo = formatTimeAgo(activity.timestamp);
    
    // 生成操作按鈕
    const actionButtons = getActionButtons(activity);
    
    return `
        <div class="timeline-item" style="--item-index: ${index}" data-id="${activity.id}">
            <div class="timeline-dot ${activity.status}"></div>
            <div class="timeline-content">
                <div onclick="toggleTimelineDetails('${activity.id}')" style="cursor: pointer;">
                    <div class="timeline-time">
                        <i class="fas fa-clock"></i>
                        ${timeAgo}
                        ${typeTag}
                    </div>
                    <div class="timeline-title">
                        ${activity.action}
                        <div>
                            <span class="text-${getStatusColor(activity.status)} mr-2">
                                <i class="fas ${statusIcon}"></i>
                            </span>
                            <i class="fas fa-chevron-down timeline-toggle"></i>
                        </div>
                    </div>
                    <div class="timeline-desc">${activity.details}</div>
                </div>
                
                <!-- 操作按鈕 -->
                ${actionButtons ? `<div class="timeline-actions">${actionButtons}</div>` : ''}
                
                <div class="timeline-details" id="details-${activity.id}">
                    <div class="timeline-meta">
                        ${activity.moduleCount ? `
                        <div class="meta-item">
                            <div class="meta-label">模組數量</div>
                            <div class="meta-value">${activity.moduleCount} 個</div>
                        </div>
                        ` : ''}
                        
                        ${activity.fileSize ? `
                        <div class="meta-item">
                            <div class="meta-label">檔案大小</div>
                            <div class="meta-value">${activity.fileSize}</div>
                        </div>
                        ` : ''}
                        
                        ${activity.duration ? `
                        <div class="meta-item">
                            <div class="meta-label">處理時間</div>
                            <div class="meta-value">${activity.duration}</div>
                        </div>
                        ` : ''}
                        
                        <div class="meta-item">
                            <div class="meta-label">完整時間</div>
                            <div class="meta-value">${activity.timestamp.toLocaleString('zh-TW')}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function extractTaskIdFromDetails(details) {
    if (!details) return null;
    
    console.log('提取 task_id，原始 details:', details);
    
    // 使用正則表達式提取 task_id
    const match = details.match(/task_\d{8}_\d{6}_[a-zA-Z0-9]+/);
    console.log('正則匹配結果:', match);
    
    const taskId = match ? match[0] : null;
    console.log('提取到的 task_id:', taskId);
    
    return taskId;
}

// 生成操作按鈕
function getActionButtons(activity) {
    console.log('生成按鈕，活動:', activity);
    console.log('task_id 檢查:', activity.task_id, typeof activity.task_id, !!activity.task_id);
    
    let buttons = '';
    
    // 根據類型生成查看歷史記錄的按鈕
    switch (activity.type) {
        case 'download':
            if (activity.task_id && activity.task_id.trim() !== '') {
                console.log('下載活動有 task_id，生成結果按鈕:', activity.task_id);
                
                if (activity.status === 'success') {
                    buttons += `<a href="/download?task_id=${activity.task_id}" class="timeline-action-btn primary">
                        <i class="fas fa-chart-line"></i> 查看下載結果
                    </a>`;
                } else if (activity.status === 'error') {
                    buttons += `<a href="/download?task_id=${activity.task_id}" class="timeline-action-btn">
                        <i class="fas fa-exclamation-circle"></i> 查看錯誤詳情
                    </a>`;
                } else if (activity.status === 'warning') {
                    buttons += `<a href="/download?task_id=${activity.task_id}" class="timeline-action-btn primary">
                        <i class="fas fa-chart-line"></i> 查看下載結果
                    </a>`;
                }
                
                if (activity.resultUrl) {
                    buttons += `<a href="${activity.resultUrl}" class="timeline-action-btn">
                        <i class="fas fa-download"></i> 下載檔案
                    </a>`;
                }
            } else {
                // 沒有 task_id 時使用傳統的歷史記錄連結
                console.log('下載活動無 task_id，使用傳統連結');
                
                if (activity.status === 'success') {
                    buttons += `<a href="/history/download/${activity.id}" class="timeline-action-btn primary">
                        <i class="fas fa-folder-open"></i> 查看下載記錄
                    </a>`;
                } else if (activity.status === 'error') {
                    buttons += `<a href="/history/download/${activity.id}" class="timeline-action-btn">
                        <i class="fas fa-exclamation-circle"></i> 查看錯誤詳情
                    </a>`;
                }
                
                if (activity.resultUrl) {
                    buttons += `<a href="${activity.resultUrl}" class="timeline-action-btn">
                        <i class="fas fa-download"></i> 下載檔案
                    </a>`;
                }
            }
            break;
            
        case 'compare':
            if (activity.task_id && activity.task_id.trim() !== '') {
                console.log('比對活動有 task_id，生成結果按鈕:', activity.task_id);
                
                if (activity.status === 'success') {
                    buttons += `<a href="/results/${activity.task_id}" class="timeline-action-btn primary">
                        <i class="fas fa-chart-line"></i> 查看比對結果
                    </a>`;
                } else if (activity.status === 'error') {
                    buttons += `<a href="/results/${activity.task_id}" class="timeline-action-btn">
                        <i class="fas fa-exclamation-circle"></i> 查看錯誤詳情
                    </a>`;
                } else if (activity.status === 'warning') {
                    buttons += `<a href="/results/${activity.task_id}" class="timeline-action-btn primary">
                        <i class="fas fa-chart-line"></i> 查看比對結果
                    </a>`;
                }
                
                if (activity.resultUrl) {
                    buttons += `<a href="${activity.resultUrl}" class="timeline-action-btn">
                        <i class="fas fa-download"></i> 下載報告
                    </a>`;
                }
            } else {
                console.log('比對活動無 task_id，顯示禁用按鈕');
                buttons += `<span class="timeline-action-btn disabled">
                    <i class="fas fa-info-circle"></i> 結果準備中
                </span>`;
            }
            break;
            
        case 'one-step':
            if (activity.task_id && activity.task_id.trim() !== '') {
                console.log('一步到位活動有 task_id，生成結果按鈕:', activity.task_id);
                
                if (activity.status === 'success') {
                    // 成功時提供三個按鈕
                    buttons += `<a href="/download?task_id=${activity.task_id}" class="timeline-action-btn">
                        <i class="fas fa-download"></i> 查看下載結果
                    </a>`;
                    buttons += `<a href="/results/${activity.task_id}" class="timeline-action-btn">
                        <i class="fas fa-code-compare"></i> 查看比對結果
                    </a>`;
                    buttons += `<a href="/one-step?task_id=${activity.task_id}" class="timeline-action-btn primary">
                        <i class="fas fa-chart-line"></i> 結果紀錄
                    </a>`;
                } else if (activity.status === 'error') {
                    // 失敗時只提供結果紀錄按鈕
                    buttons += `<a href="/one-step?task_id=${activity.task_id}" class="timeline-action-btn">
                        <i class="fas fa-chart-line"></i> 結果紀錄
                    </a>`;
                } else if (activity.status === 'warning') {
                    // 警告時提供三個按鈕
                    buttons += `<a href="/download?task_id=${activity.task_id}" class="timeline-action-btn">
                        <i class="fas fa-download"></i> 查看下載結果
                    </a>`;
                    buttons += `<a href="/results/${activity.task_id}" class="timeline-action-btn">
                        <i class="fas fa-code-compare"></i> 查看比對結果
                    </a>`;
                    buttons += `<a href="/one-step?task_id=${activity.task_id}" class="timeline-action-btn primary">
                        <i class="fas fa-chart-line"></i> 結果紀錄
                    </a>`;
                }
                
                // 如果有結果URL，額外提供下載完整報告的按鈕
                if (activity.resultUrl) {
                    buttons += `<a href="${activity.resultUrl}" class="timeline-action-btn">
                        <i class="fas fa-file-archive"></i> 下載完整報告
                    </a>`;
                }
            } else {
                // 沒有 task_id 時使用傳統的歷史記錄連結
                console.log('一步到位活動無 task_id，使用傳統連結');
                
                if (activity.status === 'success') {
                    buttons += `<a href="/history/onestep/${activity.id}" class="timeline-action-btn primary">
                        <i class="fas fa-list-alt"></i> 查看執行記錄
                    </a>`;
                } else if (activity.status === 'error') {
                    buttons += `<a href="/history/onestep/${activity.id}" class="timeline-action-btn">
                        <i class="fas fa-exclamation-circle"></i> 查看執行記錄
                    </a>`;
                }
                
                if (activity.resultUrl) {
                    buttons += `<a href="${activity.resultUrl}" class="timeline-action-btn">
                        <i class="fas fa-file-archive"></i> 下載完整報告
                    </a>`;
                }
            }
            break;
            
        case 'general':
            buttons += `<a href="/history/system/${activity.id}" class="timeline-action-btn">
                <i class="fas fa-list"></i> 查看操作記錄
            </a>`;
            break;
            
        default:
            console.log('未知的活動類型:', activity.type);
            buttons += `<a href="/history/general/${activity.id}" class="timeline-action-btn">
                <i class="fas fa-info-circle"></i> 查看詳情
            </a>`;
            break;
    }
    
    console.log('生成的按鈕 HTML:', buttons);
    return buttons;
}

// 取得狀態圖示
function getStatusIcon(status) {
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    return icons[status] || icons.info;
}

// 取得狀態顏色
function getStatusColor(status) {
    const colors = {
        success: 'success',
        error: 'danger',
        warning: 'warning',
        info: 'info'
    };
    return colors[status] || 'muted';
}

// 取得類型標籤
function getTypeTag(type) {
    const tags = {
        download: '下載',
        compare: '比較',
        'one-step': '一步到位',
        general: '一般'
    };
    return `<span class="type-tag ${type}">${tags[type] || tags.general}</span>`;
}

// 格式化時間
function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    
    if (minutes < 1) return '剛剛';
    if (minutes < 60) return `${minutes} 分鐘前`;
    
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours} 小時前`;
    
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days} 天前`;
    
    return date.toLocaleDateString('zh-TW');
}

// 切換時間線詳情
function toggleTimelineDetails(id) {
    const details = document.getElementById(`details-${id}`);
    const content = details.closest('.timeline-content');
    const toggle = content.querySelector('.timeline-toggle');
    
    if (details.classList.contains('show')) {
        details.classList.remove('show');
        content.classList.remove('expanded');
        toggle.style.transform = 'rotate(0deg)';
    } else {
        // 先關閉其他展開的項目
        document.querySelectorAll('.timeline-details.show').forEach(el => {
            el.classList.remove('show');
            el.closest('.timeline-content').classList.remove('expanded');
            el.closest('.timeline-content').querySelector('.timeline-toggle').style.transform = 'rotate(0deg)';
        });
        
        details.classList.add('show');
        content.classList.add('expanded');
        toggle.style.transform = 'rotate(180deg)';
    }
}

// 添加時間線事件
function addTimelineEvents() {
    // 阻止點擊詳情時觸發toggle
    document.querySelectorAll('.timeline-details, .timeline-actions').forEach(el => {
        el.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    });
}

// 清除所有篩選條件
function clearAllFilters() {
    document.getElementById('typeFilter').value = 'all';
    document.getElementById('timeFilter').value = 'all';
    document.getElementById('statusFilter').value = 'all';
    filterActivities();
}
</script>
{% endblock %}