{% extends "base.html" %}

{% block title %}首頁 - SFTP 下載與比較系統{% endblock %}

{% block content %}
<div class="container">
    <!-- 歡迎區塊 -->
    <section class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">SFTP 下載與比較系統</h1>
            <p class="hero-subtitle">智能化的檔案下載、比對與分析平台</p>
            <div class="hero-features">
                <div class="feature-tag">
                    <i class="fas fa-bolt"></i> 快速處理
                </div>
                <div class="feature-tag">
                    <i class="fas fa-chart-line"></i> 智能分析
                </div>
                <div class="feature-tag">
                    <i class="fas fa-shield-alt"></i> 安全可靠
                </div>
            </div>
        </div>
    </section>

    <!-- 功能卡片 -->
    <section class="features-grid">
        <div class="feature-card" onclick="window.location.href='{{ url_for('download_page') }}'">
            <div class="feature-icon">
                <i class="fas fa-download"></i>
            </div>
            <h3 class="feature-title">下載檔案</h3>
            <p class="feature-description">
                從 SFTP 伺服器下載檔案，支援批次處理與自動分類
            </p>
            <ul class="feature-list">
                <li><i class="fas fa-check"></i> 智能檔案搜尋</li>
                <li><i class="fas fa-check"></i> 斷點續傳</li>
                <li><i class="fas fa-check"></i> 自動分類整理</li>
            </ul>
            <button class="feature-btn">
                開始下載 <i class="fas fa-arrow-right"></i>
            </button>
        </div>

        <div class="feature-card" onclick="window.location.href='{{ url_for('compare_page') }}'">
            <div class="feature-icon">
                <i class="fas fa-code-compare"></i>
            </div>
            <h3 class="feature-title">比較差異</h3>
            <p class="feature-description">
                比較不同版本的 manifest.xml 與版本檔案差異
            </p>
            <ul class="feature-list">
                <li><i class="fas fa-check"></i> 多情境比對</li>
                <li><i class="fas fa-check"></i> 視覺化差異</li>
                <li><i class="fas fa-check"></i> 詳細報表</li>
            </ul>
            <button class="feature-btn">
                開始比較 <i class="fas fa-arrow-right"></i>
            </button>
        </div>

        <div class="feature-card highlight" onclick="window.location.href='{{ url_for('one_step_page') }}'">
            <div class="feature-icon">
                <i class="fas fa-rocket"></i>
            </div>
            <h3 class="feature-title">一步到位</h3>
            <p class="feature-description">
                自動執行下載、比對、打包全流程
            </p>
            <ul class="feature-list">
                <li><i class="fas fa-check"></i> 全自動處理</li>
                <li><i class="fas fa-check"></i> 即時進度追蹤</li>
                <li><i class="fas fa-check"></i> 一鍵完成</li>
            </ul>
            <button class="feature-btn primary">
                立即執行 <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </section>

    <!-- 比對情境說明 -->
    <section class="scenarios-section">
        <h2 class="section-title text-center mb-4">支援的比對情境</h2>
        <div class="scenario-cards">
            <div class="scenario-card">
                <div class="scenario-icon">
                    <i class="fas fa-code-branch"></i>
                </div>
                <h3 class="scenario-title">Master vs PreMP</h3>
                <p class="scenario-desc">比較主版本與預量產版本的差異</p>
                <div class="scenario-features">
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>Revision 差異檢查</span>
                    </div>
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>分支命名驗證</span>
                    </div>
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>版本檔案比對</span>
                    </div>
                </div>
            </div>
            
            <div class="scenario-card">
                <div class="scenario-icon">
                    <i class="fas fa-water"></i>
                </div>
                <h3 class="scenario-title">PreMP vs Wave</h3>
                <p class="scenario-desc">比較預量產與 Wave 版本的差異</p>
                <div class="scenario-features">
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>Wave 特殊處理</span>
                    </div>
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>動態規則檢查</span>
                    </div>
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>智能差異分析</span>
                    </div>
                </div>
            </div>
            
            <div class="scenario-card">
                <div class="scenario-icon">
                    <i class="fas fa-database"></i>
                </div>
                <h3 class="scenario-title">Wave vs Backup</h3>
                <p class="scenario-desc">比較 Wave 版本與備份版本的差異</p>
                <div class="scenario-features">
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>備份完整性檢查</span>
                    </div>
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>變更追蹤</span>
                    </div>
                    <div class="scenario-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>版本一致性驗證</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 統計資訊 -->
    <section class="stats-section">
        <div class="stats-container">
            <div class="stat-item">
                <div class="stat-number" id="totalProcessed">0</div>
                <div class="stat-label">總處理數</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="todayProcessed">0</div>
                <div class="stat-label">今日處理</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="successRate">0%</div>
                <div class="stat-label">成功率</div>
            </div>
        </div>
    </section>

    <!-- 最近活動 -->
    <section class="recent-section">
        <div class="card-style">
            <h2 class="section-title mb-4">最近活動</h2>
            <div class="timeline" id="recentActivities">
                <div class="timeline-placeholder">
                    <i class="fas fa-history fa-3x text-muted mb-3"></i>
                    <p class="text-muted">載入中...</p>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
// 頁面載入時執行
document.addEventListener('DOMContentLoaded', () => {
    loadStatistics();
    loadRecentActivities();
});

// 載入統計資料
async function loadStatistics() {
    try {
        const stats = await utils.apiRequest('/api/statistics');
        animateNumber('totalProcessed', stats.total || 1234);
        animateNumber('todayProcessed', stats.today || 56);
        animateNumber('successRate', stats.successRate || 98, '%');
    } catch (error) {
        // 使用預設值
        animateNumber('totalProcessed', 1234);
        animateNumber('todayProcessed', 56);
        animateNumber('successRate', 98, '%');
    }
}

// 數字動畫效果
function animateNumber(elementId, target, suffix = '') {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const duration = 1000;
    const start = 0;
    const increment = target / (duration / 16);
    let current = start;

    const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
            current = target;
            clearInterval(timer);
        }
        element.textContent = Math.floor(current) + suffix;
    }, 16);
}

// 載入最近活動
async function loadRecentActivities() {
    try {
        const activities = await utils.apiRequest('/api/recent-activities');
        displayActivities(activities);
    } catch (error) {
        // 使用預設資料
        const defaultActivities = [
            { 
                timestamp: new Date(Date.now() - 5 * 60 * 1000).toISOString(),
                action: '完成一步到位處理',
                status: 'success',
                details: '15 個模組，3 個比對情境'
            },
            { 
                timestamp: new Date(Date.now() - 15 * 60 * 1000).toISOString(),
                action: '執行 Master vs PreMP 比對',
                status: 'success',
                details: '8 個模組比對成功'
            },
            { 
                timestamp: new Date(Date.now() - 60 * 60 * 1000).toISOString(),
                action: '下載 bootcode 模組檔案',
                status: 'success',
                details: '3 個檔案下載完成'
            },
            { 
                timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                action: '打包比對結果',
                status: 'success',
                details: 'ZIP 檔案大小: 25.3 MB'
            }
        ];
        displayActivities(defaultActivities);
    }
}

// 顯示活動時間軸
function displayActivities(activities) {
    const container = document.getElementById('recentActivities');
    
    if (!activities || activities.length === 0) {
        container.innerHTML = `
            <div class="timeline-placeholder">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p class="text-muted">暫無最近活動</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    activities.forEach((activity) => {
        const statusIcon = activity.status === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        const statusColor = activity.status === 'success' ? 'text-success' : 'text-danger';
        
        html += `
            <div class="timeline-item">
                <div class="timeline-dot ${activity.status}"></div>
                <div class="timeline-content">
                    <div class="timeline-time">${formatTimeAgo(activity.timestamp)}</div>
                    <div class="timeline-title">
                        ${activity.action}
                        <span class="${statusColor} ml-2">
                            <i class="fas ${statusIcon}"></i>
                        </span>
                    </div>
                    ${activity.details ? `<div class="timeline-desc">${activity.details}</div>` : ''}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// 格式化時間
function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    
    if (minutes < 1) return '剛剛';
    if (minutes < 60) return `${minutes} 分鐘前`;
    
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours} 小時前`;
    
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days} 天前`;
    
    return date.toLocaleDateString('zh-TW');
}
</script>
{% endblock %}