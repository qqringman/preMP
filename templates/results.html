{% extends "base.html" %}

{% block title %}結果報表 - SFTP 下載與比較系統{% endblock %}

{% block extra_head %}
<!-- PivotTable.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/results.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <!-- 頁面標題 -->
    <div class="page-header">
        <h1><i class="fas fa-chart-line"></i> 比對結果報表</h1>
        <p>任務 ID: {{ task_id }}</p>
    </div>

    <!-- 資料統計 -->
    <div class="stats-section">
        <h2><i class="fas fa-chart-bar"></i> 資料統計</h2>
        <div class="stats-grid" id="statsGrid"></div>
    </div>

    <!-- 資料檢視 -->
    <div class="data-section">
        <h2><i class="fas fa-table"></i> 資料檢視</h2>
        
        <!-- 控制面板 -->
        <div class="controls">
            <!-- 情境選擇 -->
            <div class="scenario-selector">
                <label><i class="fas fa-layer-group"></i> 比對情境</label>
                <div class="scenario-tabs">
                    <button class="scenario-tab active" data-scenario="all">
                        <i class="fas fa-globe"></i> 全部情境
                    </button>
                    <button class="scenario-tab" data-scenario="master_vs_premp">
                        <i class="fas fa-code-branch"></i> Master vs PreMP
                    </button>
                    <button class="scenario-tab" data-scenario="premp_vs_wave">
                        <i class="fas fa-water"></i> PreMP vs Wave
                    </button>
                    <button class="scenario-tab" data-scenario="wave_vs_backup">
                        <i class="fas fa-archive"></i> Wave vs Backup
                    </button>
                </div>
            </div>

            <!-- 工具列 -->
            <div class="toolbar">
                <div class="toolbar-left">
                    <select class="form-input" id="sheetSelector">
                        <option value="">載入中...</option>
                    </select>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" class="search-input" id="quickSearchInput" 
                               placeholder="快速搜尋..." autocomplete="off">
                        <span class="search-count" id="searchCount"></span>
                    </div>
                </div>
                
                <div class="toolbar-right">
                    <button class="btn-icon" onclick="togglePivotMode()" title="樞紐分析">
                        <i class="fas fa-chart-pie" id="pivotIcon"></i>
                    </button>
                    <button class="btn-icon" onclick="toggleFilterPanel()" title="篩選">
                        <i class="fas fa-filter"></i>
                    </button>
                    <button class="btn btn-primary" onclick="exportCurrentView('excel')">
                        <i class="fas fa-file-excel"></i> 匯出
                    </button>
                    <button class="btn btn-success" onclick="downloadFullReport()">
                        <i class="fas fa-download"></i> 完整報表
                    </button>
                </div>
            </div>
        </div>

        <!-- 資料檢視區 -->
        <div class="data-view">
            <!-- 表格檢視 -->
            <div id="tableView" class="table-view">
                <div class="table-header">
                    <table class="data-table"><thead id="tableHead"></thead></table>
                </div>
                <div class="table-body">
                    <table class="data-table"><tbody id="tableBody"></tbody></table>
                </div>
            </div>
            
            <!-- 樞紐分析檢視 -->
            <div id="pivotView" class="pivot-view hidden">
                <div class="pivot-controls">
                    <button class="btn btn-outline" onclick="togglePivotAreas()">
                        <i class="fas fa-eye-slash" id="toggleAreasIcon"></i> 
                        <span id="toggleAreasText">隱藏拖曳區</span>
                    </button>
                    <button class="btn btn-outline" onclick="togglePivotFullscreen()">
                        <i class="fas fa-expand" id="fullscreenIcon"></i> 
                        <span id="fullscreenText">全螢幕</span>
                    </button>
                    <button class="btn btn-outline" onclick="resetPivotTable()">
                        <i class="fas fa-undo"></i> 重置
                    </button>
                    <button class="btn btn-primary" onclick="exportPivotTable()">
                        <i class="fas fa-file-excel"></i> 匯出
                    </button>
                </div>
                <div id="pivotContainer"></div>
            </div>
        </div>
    </div>

    <!-- 圖表分析 -->
    <div class="charts-section">
        <h2><i class="fas fa-chart-area"></i> 圖表分析</h2>
        <div class="charts">
            <div class="chart">
                <h3>資料分布圖</h3>
                <canvas id="distributionChart"></canvas>
            </div>
            <div class="chart">
                <h3>趨勢分析圖</h3>
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- 篩選面板 -->
<div class="filter-panel" id="filterPanel">
    <div class="filter-header">
        <h3>資料篩選器</h3>
        <button class="btn-icon" onclick="toggleFilterPanel()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="filter-content" id="filterContent"></div>
    <div class="filter-actions">
        <button class="btn btn-primary" onclick="applyFilters()">套用篩選</button>
        <button class="btn btn-outline" onclick="clearFilters()">清除篩選</button>
    </div>
</div>

<!-- 浮動按鈕 -->
<div class="fab-container">
    <button class="fab" onclick="exportPageAsHTML()" title="匯出頁面">
        <i class="fas fa-file-code"></i>
    </button>
    <button class="fab" onclick="toggleFilterPanel()" title="篩選器" id="fabFilter">
        <i class="fas fa-filter"></i>
    </button>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- 載入必要的 JS 庫 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.zh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="{{ url_for('static', filename='js/results.js') }}"></script>
{% endblock %}