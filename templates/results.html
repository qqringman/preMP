{% extends "base.html" %}

{% block title %}結果報表 - SFTP 下載與比較系統{% endblock %}

{% block extra_head %}
<!-- PivotTable.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.css">
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-chart-line"></i> 結果報表
        </h1>
        <p class="page-subtitle">任務 ID: {{ task_id }}</p>
    </div>

    <!-- 報表控制列 -->
    <div class="report-controls">
        <div class="control-group">
            <label class="control-label">選擇資料表</label>
            <select class="form-input" id="sheetSelector">
                <option value="">載入中...</option>
            </select>
        </div>
        
        <div class="control-actions">
            <button class="btn btn-primary" onclick="exportCurrentView('excel')">
                <i class="fas fa-file-excel"></i> 匯出 Excel
            </button>
            <button class="btn btn-info" onclick="exportCurrentView('html')">
                <i class="fas fa-file-code"></i> 匯出 HTML
            </button>
            <button class="btn btn-success" onclick="downloadFullReport()">
                <i class="fas fa-download"></i> 下載完整報表
            </button>
            <button class="btn btn-outline" onclick="togglePivotMode()">
                <i class="fas fa-table"></i> <span id="pivotToggleText">切換樞紐分析</span>
            </button>
        </div>
    </div>

    <!-- 資料檢視區 -->
    <div class="data-view-container">
        <!-- 一般表格檢視 -->
        <div id="tableView" class="table-view">
            <div class="table-container">
                <table id="dataTable" class="data-table">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
        
        <!-- 樞紐分析檢視 -->
        <div id="pivotView" class="pivot-view hidden">
            <div class="pivot-instructions">
                <i class="fas fa-info-circle"></i>
                <p>拖曳欄位到不同區域來建立樞紐分析表。您可以：</p>
                <ul>
                    <li>拖曳欄位到列或欄區域來分組資料</li>
                    <li>選擇不同的彙總函數（總和、平均、計數等）</li>
                    <li>使用篩選器來過濾資料</li>
                    <li>點擊表格標題來排序</li>
                </ul>
            </div>
            <div id="pivotContainer"></div>
        </div>
    </div>

    <!-- 資料統計 -->
    <div class="data-statistics">
        <h2 class="section-title">
            <i class="fas fa-chart-pie"></i> 資料統計
        </h2>
        
        <div class="stats-grid" id="statsGrid">
            <!-- 動態填充統計資料 -->
        </div>
        
        <!-- 圖表區域 -->
        <div class="charts-section">
            <div class="chart-container">
                <h3 class="chart-title">資料分布圖</h3>
                <canvas id="distributionChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">趨勢分析圖</h3>
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- 篩選器面板 -->
    <div class="filter-panel" id="filterPanel">
        <div class="filter-header">
            <h3>資料篩選器</h3>
            <button class="btn-icon" onclick="toggleFilterPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="filter-content" id="filterContent">
            <!-- 動態生成篩選器 -->
        </div>
        <div class="filter-actions">
            <button class="btn btn-primary" onclick="applyFilters()">套用篩選</button>
            <button class="btn btn-outline" onclick="clearFilters()">清除篩選</button>
        </div>
    </div>

    <!-- 浮動按鈕 -->
    <button class="fab" onclick="toggleFilterPanel()">
        <i class="fas fa-filter"></i>
    </button>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- PivotTable.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.zh.min.js"></script>
<script src="{{ url_for('static', filename='js/results.js') }}"></script>

<style>
/* 樞紐分析表樣式 */
.pivot-view {
    background: white;
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    box-shadow: var(--shadow-md);
}

.pivot-instructions {
    background: var(--nordic-blue-50);
    border-radius: var(--radius-md);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
    color: var(--nordic-blue-800);
}

.pivot-instructions ul {
    margin-top: var(--spacing-sm);
    margin-left: var(--spacing-lg);
}

/* 資料表格樣式 */
.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.data-table th {
    background: var(--nordic-blue-600);
    color: white;
    padding: var(--spacing-sm) var(--spacing-md);
    text-align: left;
    position: sticky;
    top: 0;
    cursor: pointer;
    user-select: none;
}

.data-table th:hover {
    background: var(--nordic-blue-700);
}

.data-table td {
    padding: var(--spacing-sm) var(--spacing-md);
    border-bottom: 1px solid var(--nordic-gray-200);
}

.data-table tr:hover {
    background: var(--nordic-blue-50);
}

.highlight-red {
    color: var(--nordic-red);
    font-weight: 600;
}

/* 統計卡片 */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
}

.stat-card {
    background: white;
    border-radius: var(--radius-md);
    padding: var(--spacing-lg);
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.stat-card.warning {
    border-left: 4px solid var(--nordic-yellow);
}

.stat-icon {
    width: 50px;
    height: 50px;
    background: var(--nordic-blue-100);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--nordic-blue-700);
    font-size: 1.5rem;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--nordic-gray-900);
}

.stat-label {
    color: var(--nordic-gray-600);
}

/* 篩選器面板 */
.filter-panel {
    position: fixed;
    right: -400px;
    top: 0;
    bottom: 0;
    width: 400px;
    background: white;
    box-shadow: var(--shadow-xl);
    transition: right var(--transition-normal);
    z-index: 1000;
    display: flex;
    flex-direction: column;
}

.filter-panel.show {
    right: 0;
}

.filter-header {
    padding: var(--spacing-lg);
    border-bottom: 1px solid var(--nordic-gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.filter-content {
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-lg);
}

.filter-group {
    margin-bottom: var(--spacing-lg);
}

.filter-label {
    display: block;
    font-weight: 500;
    margin-bottom: var(--spacing-xs);
    color: var(--nordic-gray-700);
}

.filter-select {
    width: 100%;
    min-height: 100px;
    border: 2px solid var(--nordic-gray-300);
    border-radius: var(--radius-md);
    padding: var(--spacing-xs);
}

.filter-actions {
    padding: var(--spacing-lg);
    border-top: 1px solid var(--nordic-gray-200);
    display: flex;
    gap: var(--spacing-sm);
}

/* 浮動按鈕 */
.fab {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--nordic-blue-600);
    color: white;
    border: none;
    box-shadow: var(--shadow-lg);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-size: 1.25rem;
}

.fab:hover {
    background: var(--nordic-blue-700);
    transform: scale(1.1);
}

/* 圖表容器 */
.charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: var(--spacing-xl);
    margin-top: var(--spacing-xl);
}

.chart-container {
    background: white;
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    box-shadow: var(--shadow-md);
}

.chart-container canvas {
    max-height: 300px;
}
</style>
{% endblock %}